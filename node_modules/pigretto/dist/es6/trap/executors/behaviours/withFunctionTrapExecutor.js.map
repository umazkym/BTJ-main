{"version":3,"sources":["../../../../../src/trap/executors/behaviours/withFunctionTrapExecutor.js"],"names":["isArray","isUndefined","throwErrorIfDoesNotImplement","withFunctionTrapExecutor","superclass","NewClass","startExecutionContext","trapArgs","executedAtLeastOnce","prototype","Object","hasOwnProperty","call","Error","name","lastProceedWithParamsIndexMap","execContextID","finalTrapArgsMap","endExecutionContext","getFinalTrapArgs","argumentsListIndex","getTrapArgsArgumentsListIndex","proceedsL","execContextStack","proceeds","length","hasParamsOverride","i","params","executeAroundAdvice","advice","rule","proceed","executeAfterAdvice","returnValue","performUnderlyingOperation","executeProceedCallback","callback","defineProperty","value","configurable"],"mappings":"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","sourcesContent":["/*\n * Copyright (c) 2020 Anton Bagdatyev (Tonix)\n *\n * Permission is hereby granted, free of charge, to any person\n * obtaining a copy of this software and associated documentation\n * files (the \"Software\"), to deal in the Software without\n * restriction, including without limitation the rights to use,\n * copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the\n * Software is furnished to do so, subject to the following\n * conditions:\n *\n * The above copyright notice and this permission notice shall be\n * included in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES\n * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND\n * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\n * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,\n * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\n * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR\n * OTHER DEALINGS IN THE SOFTWARE.\n */\n\nimport { isArray, isUndefined } from \"js-utl\";\nimport { throwErrorIfDoesNotImplement } from \"./common/throwErrorIfDoesNotImplement\";\n\nexport const withFunctionTrapExecutor = superclass => {\n  const NewClass = class extends superclass {\n    executedAtLeastOnce = false;\n    lastProceedWithParamsIndexMap = {};\n    finalTrapArgsMap = {};\n\n    startExecutionContext(trapArgs) {\n      !this.executedAtLeastOnce &&\n        throwErrorIfDoesNotImplement(\n          superclass.prototype,\n          \"startExecutionContext\",\n          superclass\n        );\n      super.startExecutionContext(trapArgs);\n      if (\n        !this.executedAtLeastOnce &&\n        !Object.prototype.hasOwnProperty.call(this, \"execContextID\")\n      ) {\n        throw new Error(\n          `pigretto - ${superclass.name} trap executor does not have \"execContextID\" property.`\n        );\n      }\n      this.lastProceedWithParamsIndexMap[this.execContextID] = -1;\n      this.finalTrapArgsMap[this.execContextID] = void 0;\n    }\n\n    endExecutionContext(trapArgs) {\n      !this.executedAtLeastOnce &&\n        throwErrorIfDoesNotImplement(\n          superclass.prototype,\n          \"endExecutionContext\",\n          superclass\n        );\n      super.endExecutionContext(trapArgs);\n      this.finalTrapArgsMap[this.execContextID] = void 0;\n      this.executedAtLeastOnce = true;\n    }\n\n    getFinalTrapArgs(trapArgs) {\n      !this.executedAtLeastOnce &&\n        throwErrorIfDoesNotImplement(\n          this,\n          \"getTrapArgsArgumentsListIndex\",\n          superclass\n        );\n      const argumentsListIndex = this.getTrapArgsArgumentsListIndex();\n      if (\n        !this.executedAtLeastOnce &&\n        !Object.prototype.hasOwnProperty.call(this, \"execContextStack\")\n      ) {\n        throw new Error(\n          `pigretto - ${superclass.name} trap executor does not have \"execContextStack\" property.`\n        );\n      }\n      const proceedsL = this.execContextStack[this.execContextID].proceeds\n        .length;\n      if (proceedsL) {\n        let hasParamsOverride = false;\n        for (\n          let i = proceedsL - 1;\n          i > this.lastProceedWithParamsIndexMap[this.execContextID];\n          i--\n        ) {\n          const { params } = this.execContextStack[this.execContextID].proceeds[\n            i\n          ];\n          if (isArray(params)) {\n            hasParamsOverride = true;\n            this.lastProceedWithParamsIndexMap[this.execContextID] = i;\n            trapArgs = [...trapArgs];\n            trapArgs[argumentsListIndex] = params;\n            this.finalTrapArgsMap[this.execContextID] = trapArgs;\n            break;\n          }\n        }\n        if (!hasParamsOverride) {\n          this.lastProceedWithParamsIndexMap[this.execContextID] =\n            proceedsL - 1;\n        }\n      }\n      if (!isUndefined(this.finalTrapArgsMap[this.execContextID])) {\n        return this.finalTrapArgsMap[this.execContextID];\n      }\n      return trapArgs;\n    }\n\n    executeAroundAdvice(trapArgs, advice, rule, proceed) {\n      trapArgs = this.getFinalTrapArgs(trapArgs);\n      !this.executedAtLeastOnce &&\n        throwErrorIfDoesNotImplement(\n          superclass.prototype,\n          \"executeAroundAdvice\",\n          superclass\n        );\n      return super.executeAroundAdvice(trapArgs, advice, rule, proceed);\n    }\n\n    executeAfterAdvice(trapArgs, advice, rule, returnValue) {\n      trapArgs = this.getFinalTrapArgs(trapArgs);\n      !this.executedAtLeastOnce &&\n        throwErrorIfDoesNotImplement(\n          superclass.prototype,\n          \"executeAfterAdvice\",\n          superclass\n        );\n      super.executeAfterAdvice(trapArgs, advice, rule, returnValue);\n    }\n\n    performUnderlyingOperation(trapArgs) {\n      trapArgs = this.getFinalTrapArgs(trapArgs);\n      !this.executedAtLeastOnce &&\n        throwErrorIfDoesNotImplement(\n          superclass.prototype,\n          \"performUnderlyingOperation\",\n          superclass\n        );\n      return super.performUnderlyingOperation(trapArgs);\n    }\n\n    executeProceedCallback(trapArgs, rule, returnValue, callback) {\n      trapArgs = this.getFinalTrapArgs(trapArgs);\n      !this.executedAtLeastOnce &&\n        throwErrorIfDoesNotImplement(\n          superclass.prototype,\n          \"executeProceedCallback\",\n          superclass\n        );\n      return super.executeProceedCallback(\n        trapArgs,\n        rule,\n        returnValue,\n        callback\n      );\n    }\n  };\n  Object.defineProperty(NewClass, \"name\", {\n    value: `WithFunctionTrapExecutor(${superclass.name})`,\n    configurable: true,\n  });\n  return NewClass;\n};\n"],"file":"withFunctionTrapExecutor.js"}